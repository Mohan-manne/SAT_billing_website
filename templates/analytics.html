<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
    <title>Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- âœ… PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4e73df">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            background: #f0f2f5;
            color: #333;
        }
        h1 {
            text-align: center;
            padding: 25px 0;
            margin: 0;
            font-size: 32px;
            background: linear-gradient(90deg, #4e73df, #1cc88a);
            color: white;
            font-weight: 700;
        }
        .filters {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px auto;
            max-width: 1200px;
        }
        .filters select, .filters input, .filters button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        .filters button {
            cursor: pointer;
            background: #4e73df;
            color: white;
            border: none;
            font-weight: 600;
            transition: 0.3s;
        }
        .filters button:hover { background: #2e59d9; }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px auto;
            max-width: 1200px;
        }
        .kpi {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s;
        }
        .kpi:hover { transform: translateY(-5px); }
        .kpi h3 { margin: 0; font-size: 16px; color: #6c757d; font-weight: 500; }
        .kpi p { margin: 10px 0 0; font-size: 22px; font-weight: 700; color: #1cc88a; }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 20px auto;
            max-width: 1200px;
        }
        .chart-row-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        .chart-card h3 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }
        .chart-card canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        table th, table td { padding: 10px 8px; text-align: center; }
        table th { background: #4e73df; color: white; }
        table tr:nth-child(even) { background: #f9f9f9; }
        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        .back-btn {
            display: inline-block;
            margin: 0 8px;
            padding: 12px 18px;
            background: #1cc88a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            text-align: center;
            transition: 0.3s;
        }
        .back-btn:hover { background: #17a673; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            h1 { font-size: 24px; padding: 15px 0; }
            .filters { flex-direction: column; align-items: stretch; }
            .filters select, .filters input, .filters button, .back-btn {
                width: 100%;
            }
            .chart-card { padding: 15px; }
            .kpi p { font-size: 18px; }
            .kpi h3 { font-size: 14px; }
        }
        @media (max-width: 480px) {
            .chart-row, .chart-row-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<h1>ANALYTICS DASHBOARD</h1>

<!-- âœ… Install App Button -->
<div style="text-align:center; margin:15px;">
    <button id="installBtn" style="display:none; padding:10px 20px; border:none; border-radius:8px; background:#4e73df; color:white; font-weight:600; cursor:pointer;">
        ðŸ“² Install App
    </button>
</div>

<!-- Filters -->
<form method="get" action="{{ url_for('analytics') }}">
    <div class="filters">
        <input type="date" name="from_date" value="{{ request.args.get('from_date','') }}">
        <input type="date" name="to_date" value="{{ request.args.get('to_date','') }}">
        <select name="mill">
            <option value="">Mill Name</option>
            {% for mill in mills %}
                <option value="{{ mill }}" {% if request.args.get('mill') == mill %}selected{% endif %}>{{ mill }}</option>
            {% endfor %}
        </select>
        <select name="village">
            <option value="">Village</option>
            {% for village in villages %}
                <option value="{{ village }}" {% if request.args.get('village') == village %}selected{% endif %}>{{ village }}</option>
            {% endfor %}
        </select>
        <select name="farmer">
            <option value="">Farmer</option>
            {% for farmer in farmers %}
                <option value="{{ farmer }}" {% if request.args.get('farmer') == farmer %}selected{% endif %}>{{ farmer }}</option>
            {% endfor %}
        </select>
        <select name="lorry">
            <option value="">Lorry No</option>
            {% for lorry in lorries %}
                <option value="{{ lorry }}" {% if request.args.get('lorry') == lorry %}selected{% endif %}>{{ lorry }}</option>
            {% endfor %}
        </select>

        <button type="submit">Apply</button>
        <a href="{{ url_for('analytics') }}"><button type="button">Reset</button></a>
        <a href="{{ url_for('menu') }}" class="back-btn">â¬… Back to Menu</a>
    </div>
</form>

<!-- KPI Cards -->
<h2 style="text-align:center;">Sales KPIs</h2>
<div class="kpi-container">
    <div class="kpi"><h3>Total Bags</h3><p>{{ sales.total_bags|round(2) }}</p></div>
    <div class="kpi"><h3>Total Ntwt</h3><p>{{ sales.total_ntwt|round(2) }}</p></div>
    <div class="kpi"><h3>Total Net Bags</h3><p>{{ sales.total_net_bags|round(2) }}</p></div>
    <div class="kpi"><h3>Total Sales Count</h3><p>{{ sales.total_count }}</p></div>
    <div class="kpi"><h3>Total Sales â‚¹</h3><p>{{ sales.total_sales|round(2) }}</p></div>
</div>

<h2 style="text-align:center;">Purchase KPIs</h2>
<div class="kpi-container">
    <div class="kpi"><h3>Total Bags</h3><p>{{ purchase.total_bags|round(2) }}</p></div>
    <div class="kpi"><h3>Total Ntwt</h3><p>{{ purchase.total_ntwt|round(2) }}</p></div>
    <div class="kpi"><h3>Total Purchase Count</h3><p>{{ purchase.total_count }}</p></div>
    <div class="kpi"><h3>Total Purchase â‚¹</h3><p>{{ purchase.total_purchase|round(2) }}</p></div>
</div>

<!-- Charts -->
<div class="chart-row chart-row-2">
    <div class="chart-card"><h3>Daily Sales vs Purchases</h3><canvas id="dailyBar"></canvas></div>
    <div class="chart-card"><h3>Weekly Sales vs Purchases</h3><canvas id="weeklyBar"></canvas></div>
</div>

<div class="chart-row chart-row-2">
    <div class="chart-card"><h3>Monthly Sales & Purchase Trend</h3><canvas id="monthlyTrend"></canvas></div>
    <div class="chart-card"><h3>Monthly Difference (Sales - Purchase)</h3><canvas id="monthlyDiff"></canvas></div>
</div>

<div class="chart-row chart-row-2">
    <div class="chart-card"><h3>Total Bags Distribution</h3><canvas id="donutBags"></canvas></div>
    <div class="chart-card"><h3>Total Amount Distribution</h3><canvas id="pieAmounts"></canvas></div>
</div>

<div class="chart-row chart-row-2">
    <div class="chart-card"><h3>Top Farmers by Purchase Amount (Lollipop)</h3><canvas id="topFarmers"></canvas></div>
    <div class="chart-card"><h3>Top Villages by Bags (Area Chart)</h3><canvas id="topVillages"></canvas></div>
</div>

<div class="chart-row chart-row-2">
    <div class="chart-card"><h3>Top Mills by Sales Amount</h3><canvas id="topMills"></canvas></div>
    <div class="chart-card"><h3>Top Trucks by Bags (Column Chart)</h3><canvas id="topTrucks"></canvas></div>
</div>

<!-- Sales Records -->
<div class="chart-card" style="margin:20px;">
    <h3 style="text-align:center;">Sales Records</h3>
    <div class="table-container">
        <table>
            <tr><th>Date</th><th>Mill</th><th>Farmer</th><th>Lorry</th><th>Bags</th><th>Ntwt</th><th>Amount</th></tr>
            {% for row in sales_records %}
            <tr>
                <td>{{ row.date }}</td><td>{{ row.mill }}</td><td>{{ row.farmer }}</td>
                <td>{{ row.lorry }}</td><td>{{ row.bags }}</td><td>{{ row.ntwt }}</td><td>{{ row.amount }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<!-- Purchase Records -->
<div class="chart-card" style="margin:20px;">
    <h3 style="text-align:center;">Purchase Records</h3>
    <div class="table-container">
        <table>
            <tr><th>Date</th><th>Mill</th><th>Farmer</th><th>Village</th><th>Lorry</th><th>Bags</th><th>Ntwt</th><th>Amount</th></tr>
            {% for row in purchase_records %}
            <tr>
                <td>{{ row.date }}</td><td>{{ row.mill }}</td><td>{{ row.farmer }}</td>
                <td>{{ row.village }}</td><td>{{ row.lorry }}</td>
                <td>{{ row.bags }}</td><td>{{ row.ntwt }}</td><td>{{ row.amount }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<script>
    // âœ… PWA Install Button Handler
    let deferredPrompt;
    const installBtn = document.getElementById("installBtn");

    window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = "inline-block";
    });

    installBtn.addEventListener("click", () => {
        installBtn.style.display = "none";
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === "accepted") {
                console.log("User accepted the install prompt");
            } else {
                console.log("User dismissed the install prompt");
            }
            deferredPrompt = null;
        });
    });

    // âœ… Register Service Worker
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/service-worker.js")
            .then(() => console.log("Service Worker Registered âœ…"))
            .catch((err) => console.error("Service Worker Failed:", err));
    }
</script>

<script>
    // Palette
    const C_SALES = "#4e73df";
    const C_PURCH = "#1cc88a";
    const C_ACCENT = "#f6c23e";
    const C_DANGER = "#e74a3b";

    // Daily
    new Chart(document.getElementById("dailyBar"), {
        type: 'bar',
        data: {
            labels: {{ daily_labels|safe }},
            datasets: [
                { label: "Sales â‚¹", data: {{ daily_sales|safe }}, backgroundColor: C_SALES },
                { label: "Purchase â‚¹", data: {{ daily_purchase|safe }}, backgroundColor: C_PURCH }
            ]
        }
    });

    // Weekly
    new Chart(document.getElementById("weeklyBar"), {
        type: 'bar',
        data: {
            labels: {{ weekly_labels|safe }},
            datasets: [
                { label: "Sales â‚¹", data: {{ weekly_sales|safe }}, backgroundColor: C_SALES },
                { label: "Purchase â‚¹", data: {{ weekly_purchase|safe }}, backgroundColor: C_PURCH }
            ]
        }
    });

    // Monthly trend
    new Chart(document.getElementById("monthlyTrend"), {
        type: 'line',
        data: {
            labels: {{ trend_labels|safe }},
            datasets: [
                { label: 'Sales â‚¹', data: {{ trend_sales|safe }}, borderColor: C_SALES, backgroundColor: "rgba(78,115,223,0.1)", fill: true, tension: 0.3 },
                { label: 'Purchase â‚¹', data: {{ trend_purchase|safe }}, borderColor: C_PURCH, backgroundColor: "rgba(28,200,138,0.1)", fill: true, tension: 0.3 }
            ]
        }
    });

    // Monthly diff
    new Chart(document.getElementById("monthlyDiff"), {
        type: 'bar',
        data: {
            labels: {{ diff_labels|safe }},
            datasets: [
                { label: 'profit â‚¹ (Sales - Purchase)', data: {{ monthly_diff|safe }}, backgroundColor: C_ACCENT }
            ]
        }
    });

    // Donut bags
    new Chart(document.getElementById("donutBags"), {
        type: 'doughnut',
        data: {
            labels: ["Bags (Sales)", "Bags (Purchase)"],
            datasets: [{ data: {{ donut_bags|safe }}, backgroundColor: [C_ACCENT, C_DANGER] }]
        }
    });

    // Pie amounts
    new Chart(document.getElementById("pieAmounts"), {
        type: 'pie',
        data: {
            labels: ["Sales", "Purchase"],
            datasets: [{ data: {{ pie_amounts|safe }}, backgroundColor: [C_SALES, C_PURCH] }]
        }
    });

    // Top Farmers (Lollipop â†’ bar + scatter overlay)
    const farmersLabels = {{ top_farmers_labels|safe }};
    const farmersValues = {{ top_farmers_values|safe }};
    new Chart(document.getElementById("topFarmers"), {
        data: {
            labels: farmersLabels,
            datasets: [
                { 
                    type: 'bar', 
                    label: 'Purchase â‚¹', 
                    data: farmersValues, 
                    backgroundColor: C_PURCH 
                },
                { 
                    type: 'scatter', 
                    label: 'Points', 
                    data: farmersValues.map((v,i)=>({x:i,y:v})), 
                    backgroundColor: C_DANGER, 
                    pointRadius: 6 
                }
            ]
        },
        options: { indexAxis: 'x' }
    });

    // Top Villages (Area)
    new Chart(document.getElementById("topVillages"), {
        type: 'line',
        data: {
            labels: {{ top_villages_labels|safe }},
            datasets: [
                { label: 'Bags', data: {{ top_villages_values|safe }}, borderColor: C_ACCENT, backgroundColor: "rgba(246,194,62,0.3)", fill: true, tension: 0.4 }
            ]
        }
    });

    // Top Mills
    new Chart(document.getElementById("topMills"), {
        type: 'bar',
        data: {
            labels: {{ top_mills_labels|safe }},
            datasets: [{ label: 'Sales â‚¹', data: {{ top_mills_values|safe }}, backgroundColor: C_SALES }]
        },
        options: { indexAxis: 'y' }
    });

    // Top Trucks (Column)
    new Chart(document.getElementById("topTrucks"), {
        type: 'bar',
        data: {
            labels: {{ top_trucks_labels|safe }},
            datasets: [{ label: 'Bags', data: {{ top_trucks_values|safe }}, backgroundColor: C_DANGER }]
        }
    });
</script>

</body>
</html>
